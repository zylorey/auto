import webview
import threading
import time
import pyautogui
import keyboard
import os
from pynput.mouse import Controller

HTML_TEMPLATE = """
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-deep: #05070a;
            --accent-royal: #2962ff;
            --accent-neon: #00d4ff;
            --accent-green: #55FF00;
            --accent-stop: #ff2957;
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #ffffff;
            --text-muted: #8b9bb4;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-deep);
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(41, 98, 255, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(0, 212, 255, 0.1) 0%, transparent 40%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            color: var(--text-main);
        }
        .app-container {
            width: 100%;
            height: 100%;
            padding: 30px;
            background: linear-gradient(145deg, rgba(16, 22, 36, 0.7), rgba(5, 7, 10, 0.9));
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .header h1 {
            font-size: 18px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase;
            background: linear-gradient(90deg, #fff, #8b9bb4); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .status-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-bottom: 30px; }
        .pill {
            display: flex; justify-content: space-between; align-items: center; padding: 12px 16px;
            background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 50px; font-size: 13px; transition: all 0.3s ease;
        }
        .pill-label { color: var(--text-muted); font-weight: 500; }
        .pill-value { font-weight: 600; color: var(--text-main); text-shadow: 0 0 10px rgba(255,255,255,0.1); }
        
        .status-value.stopped { color: var(--accent-stop); text-shadow: 0 0 8px rgba(255, 41, 87, 0.4); }
        .status-value.running { color: var(--accent-green); text-shadow: 0 0 8px rgba(0, 212, 255, 0.4); }
        .status-value.drag { color: #55FF00; text-shadow: 0 0 8px rgba(255, 165, 0, 0.4); }
        .status-value.waiting { color: #55FF00; text-shadow: 0 0 8px rgba(189, 0, 255, 0.4); }

        .main-action-area { display: flex; flex-direction: column; gap: 15px; margin-bottom: 25px; }
        .cyber-btn {
            position: relative; width: 100%; height: 60px; border: none; outline: none;
            border-radius: 16px; background: linear-gradient(180deg, #3a7bd5 0%, #2962ff 100%);
            color: white; font-family: 'Inter', sans-serif; font-size: 16px; font-weight: 700;
            cursor: pointer; overflow: hidden; transition: all 0.2s;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.4), 0 10px 20px rgba(41, 98, 255, 0.4), 0 0 0 2px rgba(41, 98, 255, 0.2);
            display: flex; align-items: center; justify-content: center;
        }
        .cyber-btn:hover { transform: translateY(-2px); box-shadow: 0 15px 30px rgba(41, 98, 255, 0.6); }
        .cyber-btn.btn-stop {
            background: linear-gradient(180deg, #ff4b73 0%, #d50032 100%);
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.4), 0 10px 20px rgba(213, 0, 50, 0.4), 0 0 0 2px rgba(213, 0, 50, 0.2); 
            display: none;
        }
        .secondary-controls { display: flex; gap: 10px; }
        .glass-btn {
            flex: 1; padding: 12px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-muted); border-radius: 12px; font-size: 12px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s;
        }
        .glass-btn:hover { background: rgba(255,255,255,0.08); color: white; }
        .glass-btn.active { color: var(--accent-neon); border-color: var(--accent-neon); background: rgba(0, 212, 255, 0.05); }
        .glass-btn.disabled { opacity: 0.5; color: var(--accent-stop); border-color: var(--accent-stop); }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>Auto <span style="font-weight: 300; opacity: 0.6; font-size: 0.8em;">V2.0</span></h1>
        </div>
        <div class="status-grid">
            <div class="pill">
                <span class="pill-label"><i class="fas fa-microchip"></i> Status</span>
                <span class="pill-value status-value stopped" id="statusText">Stopped</span>
            </div>
            <div class="pill">
                <span class="pill-label"><i class="fas fa-sync-alt"></i> Progress</span>
                <span class="pill-value" id="loopText">Set 0/3 - Loop 0/9</span>
            </div>
        </div>
        <div class="main-action-area">
            <button class="cyber-btn" id="startBtn" onclick="callPythonStart()">
                <i class="fas fa-play" style="margin-right: 8px;"></i> INITIALIZE (O)
            </button>
            <button class="cyber-btn btn-stop" id="stopBtn" onclick="callPythonStop()">
                <i class="fas fa-stop" style="margin-right: 8px;"></i> TERMINATE (P)
            </button>
        </div>
        <div class="secondary-controls">
            <button class="glass-btn active" id="keybindBtn" onclick="callPythonToggle()">
                <i class="fas fa-keyboard"></i> Keybinds
            </button>
        </div>
    </div>
    <script>
        function callPythonStart() { window.pywebview.api.start_action(); }
        function callPythonStop() { window.pywebview.api.stop_action(); }
        function callPythonToggle() { window.pywebview.api.toggle_keybinds(); }

        function setRunningState(isRunning) {
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            startBtn.style.display = isRunning ? 'none' : 'flex';
            stopBtn.style.display = isRunning ? 'flex' : 'none';
        }

        function updateStatus(text, type) {
            const el = document.getElementById('statusText');
            el.innerText = text;
            el.className = 'pill-value status-value ' + type;
        }

        function updateLoopCounter(text) {
            document.getElementById('loopText').innerText = text;
        }

        function updateKeybindBtn(isEnabled) {
            const btn = document.getElementById('keybindBtn');
            if (isEnabled) {
                btn.classList.add('active');
                btn.classList.remove('disabled');
                btn.innerHTML = '<i class="fas fa-keyboard"></i> Keybinds';
            } else {
                btn.classList.remove('active');
                btn.classList.add('disabled');
                btn.innerHTML = '<i class="fas fa-keyboard"></i> Off';
            }
        }
    </script>
</body>
</html>
"""

class AutomationBackend:
    def __init__(self):
        self.running = False
        self.keybinds_enabled = True
        self.mouse = Controller()
        self.window = None

    def set_window(self, window):
        self.window = window

    # --- UI Updaters ---
    def ui_set_running(self, state):
        if self.window:
            self.window.evaluate_js(f'setRunningState({str(state).lower()})')

    def ui_update_status(self, text, type_class):
        if self.window:
            self.window.evaluate_js(f'updateStatus("{text}", "{type_class}")')

    def ui_update_loop(self, text):
        if self.window:
            self.window.evaluate_js(f'updateLoopCounter("{text}")')
            
    def ui_update_keybinds(self, enabled):
        if self.window:
            self.window.evaluate_js(f'updateKeybindBtn({str(enabled).lower()})')

    # --- Logic ---
    def toggle_keybinds(self):
        self.keybinds_enabled = not self.keybinds_enabled
        self.ui_update_keybinds(self.keybinds_enabled)

    def start(self):
        if not self.running:
            self.running = True
            self.ui_set_running(True)
            self.ui_update_status("Running", "running")
            # Using threading directly here
            thread = threading.Thread(target=self.run_automation)
            thread.daemon = True
            thread.start()

    def stop(self):
        if self.running:
            self.running = False
            self.ui_set_running(False)
            self.ui_update_status("Stopped", "stopped")

    def drag_sequence(self, y_coord):
        try:
            pyautogui.press('e')
            time.sleep(0.3)
            pyautogui.keyDown('shift')
            time.sleep(0.2)
            pyautogui.moveTo(1245, y_coord, duration=0.2)
            time.sleep(0.1)
            pyautogui.mouseDown(button='left')
            time.sleep(0.1)
            pyautogui.moveTo(670, y_coord, duration=0.5)
            time.sleep(0.1)
            pyautogui.mouseUp(button='left')
            time.sleep(0.1)
            pyautogui.keyUp('shift')
            time.sleep(0.3)
            pyautogui.press('esc')
            time.sleep(0.2)
        except Exception:
            pyautogui.keyUp('shift')

    def run_automation(self):
        # Native Windows Clipboard (Zero Library)
        os.system('echo /ah sell 200k | clip')
        
        y_coordinates = [700, 650, 550]
        set_count = 0

        while self.running and set_count < 3:
            y_coord = y_coordinates[set_count]
            
            self.ui_update_status(f"Drag Y:{y_coord}", "drag")
            self.drag_sequence(y_coord)

            if not self.running: break

            self.ui_update_status("Waiting...", "waiting")
            time.sleep(1.0)

            if not self.running: break

            loop_count = 0
            self.ui_update_status("Selling", "running")

            while self.running and loop_count < 9:
                pyautogui.press('t')
                pyautogui.hotkey('ctrl', 'v')
                pyautogui.press('enter')
                pyautogui.click(1101, 364, duration=0.3)
                self.mouse.scroll(0, 1)

                loop_count += 1
                self.ui_update_loop(f"Set {set_count + 1}/3 - Loop {loop_count} / 9")
                time.sleep(0.1)

            set_count += 1

        if set_count >= 3 and self.running:
            self.ui_update_loop("All Sets Complete!")
            self.stop()

# --- API Bridge ---
class Api:
    def __init__(self, backend):
        self.backend = backend
    def start_action(self): self.backend.start()
    def stop_action(self): self.backend.stop()
    def toggle_keybinds(self): self.backend.toggle_keybinds()

if __name__ == '__main__':
    backend = AutomationBackend()
    api = Api(backend)

    # Hotkeys
    keyboard.add_hotkey('o', lambda: backend.start() if backend.keybinds_enabled else None)
    keyboard.add_hotkey('p', backend.stop)

    # App Window
    window = webview.create_window(
        "Auto", 
        html=HTML_TEMPLATE, 
        js_api=api, 
        width=400, 
        height=400,
        resizable=False,
        on_top=True
    )
    
    backend.set_window(window)
    webview.start()
